<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>doclittle- AI Voice Receptionist - Client Record</title>
  <link rel="stylesheet" href="../assets/css/global.css">
  <script src="../assets/js/config.js"></script>
  <style>
    :root { --primary:#0891b2; --primary-dark:#0e7490; --primary-light:#06b6d4; }
    .layout { display:flex; min-height:100vh; }
    .sidebar { width:260px; background:#fff; box-shadow:2px 0 10px rgba(0,0,0,0.05); position:fixed; height:100vh; overflow-y:auto; }
    .sidebar-header { padding:24px; border-bottom:1px solid var(--gray-200); }
    .sidebar-logo { font-size:32px; line-height:1; letter-spacing:-3px; color:#2d3748; margin-bottom:4px; }
    .sidebar-logo .doc { font-family:'Times New Roman', Times, serif; font-style:italic; }
    .sidebar-logo .little { font-family:'Verdana', Geneva, sans-serif; font-weight:700; }
    .sidebar-subtitle { font-size:12px; color:var(--gray-500); margin-top:4px; }
    .sidebar-nav { padding:16px; }
    .nav-item { display:flex; align-items:center; gap:12px; padding:12px 16px; border-radius:8px; color:var(--gray-700); font-weight:500; cursor:pointer; transition:all .2s; margin-bottom:4px; text-decoration:none; }
    .nav-item:hover { background:var(--gray-50); color:var(--primary); }
    .nav-item.active { background:var(--primary); color:#fff; }
    .nav-icon { font-size:20px; }
    .sidebar-footer { padding:16px; border-top:1px solid var(--gray-200); position:absolute; bottom:0; width:260px; background:#fff; }
    .user-info { display:flex; align-items:center; gap:12px; padding:12px; border-radius:8px; background:var(--gray-50); }
    .user-avatar { width:40px; height:40px; border-radius:50%; background:var(--primary); color:#fff; display:flex; align-items:center; justify-content:center; font-weight:700; }
    .user-details { flex:1; }
    .user-name { font-weight:600; font-size:14px; color:var(--gray-900); }
    .logout-btn { background:none; border:none; color:var(--gray-500); cursor:pointer; padding:8px; border-radius:4px; transition:all .2s; }
    .logout-btn:hover { background:var(--danger-light); color:var(--danger); }
    .main-content { margin-left:260px; flex:1; padding:32px; background:var(--gray-50); }
    .page-header { background:#fff; border-radius:12px; padding:24px; margin-bottom:16px; box-shadow:var(--shadow-md); display:flex; justify-content:space-between; align-items:flex-start; }
    .page-title { font-size:26px; margin:0; }
    .record-no { font-size:12px; color:var(--gray-500); }
    .grid { display:grid; grid-template-columns: 1fr 1fr; gap:24px; }
    .card { background:#fff; border-radius:12px; padding:20px; box-shadow:var(--shadow-md); }
    .card h3 { margin:0 0 12px 0; font-size:16px; }
    .kv { display:grid; grid-template-columns: 160px 1fr; row-gap:8px; column-gap:12px; }
    .kv div { font-size:14px; }
    .badge { padding:4px 10px; border-radius:9999px; font-size:12px; font-weight:700; display:inline-block; }
    .appt { display:flex; justify-content:space-between; border-bottom:1px solid var(--gray-200); padding:8px 0; font-size:14px; }
    .appt:last-child { border-bottom:none; }
    .actions { display:flex; gap:8px; }
  </style>
</head>
<body>
  <div class="layout">
    <aside class="sidebar">
      <div class="sidebar-header">
        <div class="sidebar-logo"><span class="doc">Doc</span><span class="little">Little</span><span style="font-weight:700;">.</span></div>
        <div class="sidebar-subtitle">AI Voice Receptionist</div>
      </div>
      <nav class="sidebar-nav">
        <a href="dashboard.html" class="nav-item"><span class="nav-icon">üìä</span><span>Dashboard</span></a>
        <a href="patients.html" class="nav-item"><span class="nav-icon">üë•</span><span>Clients</span></a>
        <a href="calendar.html" class="nav-item"><span class="nav-icon">üìÖ</span><span>Calendar</span></a>
        <a href="records.html" class="nav-item active"><span class="nav-icon">üìÅ</span><span>Records</span></a>
        <a href="orders.html" class="nav-item"><span class="nav-icon">üí≥</span><span>Billing</span></a>
        <a href="agent.html" class="nav-item"><span class="nav-icon">üéôÔ∏è</span><span>Voice Agent</span></a>
        <a href="treatments.html" class="nav-item"><span class="nav-icon">üè∑Ô∏è</span><span>Treatments</span></a>
        <a href="settings.html" class="nav-item"><span class="nav-icon">‚öôÔ∏è</span><span>Settings</span></a>
      </nav>
    </aside>

    <main class="main-content">
      <div class="page-header">
        <div>
          <h1 class="page-title">Client Record</h1>
          <div class="record-no" id="recordNo">Record No: ‚Äî</div>
        </div>
        <div class="actions">
          <button class="btn btn-secondary" onclick="window.history.back()">Back</button>
          <button class="btn btn-primary" onclick="openInCalendar()">Open Calendar</button>
        </div>
      </div>

      <div class="grid">
        <div class="card">
          <h3>Demographics</h3>
          <div class="kv">
            <div>Full Name</div><div id="pName">‚Äî</div>
            <div>Phone</div><div id="pPhone">‚Äî</div>
            <div>Email</div><div id="pEmail">‚Äî</div>
            <div>Birth Date</div><div id="pDOB">‚Äî</div>
            <div>Address</div><div id="pAddr">‚Äî</div>
          </div>
        </div>

        <div class="card">
          <h3>Identifiers</h3>
          <div class="kv">
            <div>FHIR Patient ID</div><div id="pFhir">‚Äî</div>
            <div>Record Number</div><div id="pMRN">‚Äî</div>
          </div>
        </div>

        <div class="card" style="grid-column:1 / -1;">
          <h3>Appointments</h3>
          <div id="apptList">Loading‚Ä¶</div>
        </div>
      </div>
    </main>
  </div>

  <script>
    const API_BASE = window.API_BASE || 'http://localhost:4000';
    const url = new URL(window.location.href);
    const fhirId = url.searchParams.get('id');
    let nextCalendarLink = null;

    document.addEventListener('DOMContentLoaded', async () => {
      if (!fhirId) { document.getElementById('apptList').textContent = 'Missing patient id'; return; }
      document.getElementById('recordNo').textContent = `Record No: ${fhirId}`;
      document.getElementById('pMRN').textContent = fhirId;
      document.getElementById('pFhir').textContent = fhirId;

      const patient = await fetchPatient(fhirId);
      if (patient) fillDemographics(patient);

      const { phone, email } = extractTelecom(patient);
      await loadAppointments(phone, email);
    });

    async function fetchPatient(id) {
      // Try /fhir/Patient/{id}, fallback to search
      try {
        const r = await fetch(`${API_BASE}/fhir/Patient/${id}`);
        if (r.ok) return await r.json();
      } catch {}
      try {
        const r2 = await fetch(`${API_BASE}/fhir/Patient?id=${encodeURIComponent(id)}`);
        const b = await r2.json();
        if (b.resourceType === 'Bundle' && b.entry && b.entry[0]) return b.entry[0].resource;
      } catch {}
      return null;
    }

    function extractTelecom(p) {
      const telecom = (p && p.telecom) || [];
      const phone = (telecom.find(t => t.system==='phone')||{}).value || '';
      const email = (telecom.find(t => t.system==='email')||{}).value || '';
      return { phone, email };
    }

    function fillDemographics(p) {
      const nameObj = (p.name && p.name[0]) || {};
      const fullName = `${(nameObj.given||[''])[0]} ${nameObj.family||''}`.trim() || 'Unknown';
      const { phone, email } = extractTelecom(p);
      const addr = (p.address && p.address[0]) || {};
      const addrStr = [addr.line && addr.line[0], addr.city, addr.state, addr.postalCode].filter(Boolean).join(', ');
      document.getElementById('pName').textContent = fullName;
      document.getElementById('pPhone').textContent = phone || '‚Äî';
      document.getElementById('pEmail').textContent = email || '‚Äî';
      document.getElementById('pDOB').textContent = p.birthDate || '‚Äî';
      document.getElementById('pAddr').textContent = addrStr || '‚Äî';
    }

    async function loadAppointments(phone, email) {
      try {
        const r = await fetch(`${API_BASE}/voice/appointments/search`, {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ args: { phone: phone || undefined, email: email || undefined } })
        });
        const data = await r.json();
        const appts = data.success ? (data.appointments||[]) : [];
        const list = document.getElementById('apptList');
        if (appts.length === 0) { list.textContent = 'No appointments yet.'; return; }
        list.innerHTML = appts.map(a => {
          if (!nextCalendarLink && a.calendar_link) nextCalendarLink = a.calendar_link;
          return `<div class="appt"><div>${a.appointment_type || 'Consultation'} ‚Äî <span class="badge">${a.status}</span></div><div>${a.datetime_display || ''}</div></div>`;
        }).join('');
      } catch (e) {
        document.getElementById('apptList').textContent = 'Failed to load appointments.';
      }
    }

    function openInCalendar() {
      if (nextCalendarLink) window.open(nextCalendarLink, '_blank'); else window.location.href='calendar.html';
    }
  </script>
</body>
</html>


