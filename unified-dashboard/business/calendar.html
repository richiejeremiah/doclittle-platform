<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Medical Coding Assistant - Appointments Calendar</title>

  <!-- FullCalendar (reliable grid) -->
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>

  <link rel="stylesheet" href="../assets/css/global.css">
  <script src="../assets/js/config.js"></script>
  <style>
    /* Shared app layout (copied from patients/dashboard for left sidebar) */
    :root {
      --primary: #1e40af;
      --primary-dark: #1e3a8a;
      --primary-light: #3b82f6;
    }

    .layout {
      display: flex;
      min-height: 100vh;
    }

    .sidebar {
      width: 260px;
      background: #fff;
      box-shadow: 2px 0 10px rgba(0, 0, 0, 0.05);
      position: fixed;
      height: 100vh;
      overflow-y: auto;
    }

    .sidebar-header {
      padding: 24px;
      border-bottom: 1px solid var(--gray-200);
    }

    .sidebar-logo {
      font-size: 32px;
      line-height: 1;
      letter-spacing: -3px;
      color: #2d3748;
      margin-bottom: 4px;
    }

    .sidebar-logo .doc {
      font-family: 'Times New Roman', Times, serif;
      font-style: italic;
    }

    .sidebar-logo .little {
      font-family: 'Verdana', Geneva, sans-serif;
      font-weight: 700;
    }

    .sidebar-subtitle {
      font-size: 12px;
      color: var(--gray-500);
      margin-top: 4px;
    }

    .sidebar-nav {
      padding: 16px;
    }

    .nav-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      border-radius: 8px;
      color: var(--gray-700);
      font-weight: 500;
      cursor: pointer;
      transition: all .2s;
      margin-bottom: 4px;
      text-decoration: none;
    }

    .nav-item:hover {
      background: var(--gray-50);
      color: var(--primary);
    }

    .nav-item.active {
      background: var(--primary);
      color: #fff;
    }

    .nav-icon {
      font-size: 20px;
    }

    .sidebar-footer {
      padding: 16px;
      border-top: 1px solid var(--gray-200);
      position: absolute;
      bottom: 0;
      width: 260px;
      background: #fff;
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      border-radius: 8px;
      background: var(--gray-50);
    }

    .user-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--primary);
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
    }

    .user-details {
      flex: 1;
    }

    .user-name {
      font-weight: 600;
      font-size: 14px;
      color: var(--gray-900);
    }

    .logout-btn {
      background: none;
      border: none;
      color: var(--gray-500);
      cursor: pointer;
      padding: 8px;
      border-radius: 4px;
      transition: all .2s;
    }

    .logout-btn:hover {
      background: var(--danger-light);
      color: var(--danger);
    }

    .main-content {
      margin-left: 260px;
      flex: 1;
      padding: 32px;
      background: var(--gray-50);
    }

    .page-header {
      background: #fff;
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 16px;
      box-shadow: var(--shadow-md);
    }

    .page-title {
      font-size: 28px;
      margin-bottom: 8px;
    }

    .page-subtitle {
      color: var(--gray-600);
      font-size: 14px;
    }

    :root {
      --primary: #1e40af;
      --primary-dark: #1e3a8a;
      --primary-light: #3b82f6;
      --bg: #f3f4f6;
      --muted: #6b7280;
      --card: #ffffff;
      --border: #e5e7eb;
      --success: #10b981;
      --danger: #ef4444;
      --warning: #f59e0b;
    }

    body {
      background: linear-gradient(180deg, #f8fafc, #eef2f7 40%, #e6f7fb 100%);
    }

    .topbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 24px;
      background: var(--card);
      border-bottom: 1px solid var(--border);
      box-shadow: 0 6px 20px rgba(14, 116, 144, 0.06);
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .logo {
      font-size: 24px;
      letter-spacing: -2px;
      color: #1f2937;
    }

    .logo .doc {
      font-family: 'Times New Roman', Times, serif;
      font-style: italic;
    }

    .logo .little {
      font-family: 'Verdana', Geneva, sans-serif;
      font-weight: 700;
    }

    .title {
      font-weight: 800;
      color: var(--primary-dark);
      margin-left: 8px;
    }

    .filters {
      display: flex;
      gap: 12px;
      align-items: center;
    }

    .input,
    .select,
    .btn {
      padding: 10px 12px;
      border: 1px solid var(--border);
      border-radius: 10px;
      background: #fff;
      color: #111827;
    }

    .btn-primary {
      background: var(--primary);
      color: #fff;
      border-color: transparent;
    }

    .btn-primary:hover {
      background: var(--primary-dark);
    }

    .link {
      color: var(--primary-dark);
      text-decoration: none;
      font-weight: 600;
    }

    #calendarWrap {
      max-width: 1200px;
      margin: 16px auto;
    }

    #calendar {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 14px;
      box-shadow: 0 10px 30px rgba(8, 145, 178, 0.08);
      min-height: 760px;
    }

    .legend {
      display: flex;
      gap: 16px;
      padding: 8px 16px;
      align-items: center;
    }

    .legend .item {
      display: flex;
      gap: 8px;
      align-items: center;
      font-size: 12px;
      color: #4b5563;
      background: #fff;
      border: 1px solid var(--border);
      padding: 6px 10px;
      border-radius: 9999px;
    }

    .dot {
      width: 10px;
      height: 10px;
      border-radius: 9999px;
      display: inline-block;
    }

    .fc .fc-toolbar-title {
      font-weight: 800;
      color: #111827;
    }

    .fc-theme-standard td,
    .fc-theme-standard th {
      border-color: var(--border);
    }

    .fc-event {
      cursor: pointer;
      border-radius: 8px;
    }

    .badge {
      padding: 4px 10px;
      border-radius: 9999px;
      font-size: 12px;
      font-weight: 700;
      display: inline-block;
    }

    .badge-scheduled {
      background: #e0f7fb;
      color: #036a7e;
    }

    .badge-confirmed {
      background: #dcfce7;
      color: #065f46;
    }

    .badge-cancelled {
      background: #fee2e2;
      color: #991b1b;
    }

    .section {
      display: flex;
      gap: 24px;
      align-items: center;
      padding: 12px 16px;
      background: #f9fafb;
      border: 1px dashed var(--border);
      border-radius: 12px;
      margin: 8px 16px;
    }

    .section h4 {
      margin: 0;
      color: #374151;
    }
  </style>
</head>

<body style="background:#f3f4f6;">
  <div class="layout">
    <!-- Sidebar (same as other pages) -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <div class="sidebar-logo">
          <span class="doc">Doc</span><span class="little">Little</span><span style="font-weight:700;">.</span>
        </div>
        <div class="sidebar-subtitle">Medical Coding Assistant</div>
      </div>

      <nav class="sidebar-nav">
        <a href="pdf-coding.html" class="nav-item">
          <span class="nav-icon">ðŸ“„</span>
          <span>Scan</span>
        </a>
        <a href="invoices.html" class="nav-item">
          <span class="nav-icon">ðŸ§¾</span>
          <span>Invoices</span>
        </a>
        <a href="patients.html" class="nav-item">
          <span class="nav-icon">ðŸ‘¥</span>
          <span>Patients</span>
        </a>
        <a href="billing.html" class="nav-item">
          <span class="nav-icon">ðŸ’³</span>
          <span>Billing</span>
        </a>
        <a href="wallets.html" class="nav-item">
          <span class="nav-icon">ðŸ’°</span>
          <span>Wallets</span>
        </a>
        <a href="calendar.html" class="nav-item active">
          <span class="nav-icon">ðŸ“…</span>
          <span>Calendar</span>
        </a>
      </nav>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
      <div class="page-header">
        <h1 class="page-title">Appointments Calendar</h1>
        <p class="page-subtitle">View and manage all bookings from the AI Voice Agent</p>
      </div>

      <!-- Toolbar -->
      <div class="topbar" style="border-radius:12px;">
        <div class="brand">
          <div class="title">Filters</div>
        </div>
        <div class="filters">
          <input type="date" id="dateFilter" class="input" />
          <select id="statusFilter" class="select">
            <option value="">All Statuses</option>
            <option value="scheduled">Scheduled</option>
            <option value="confirmed">Confirmed</option>
            <option value="cancelled">Cancelled</option>
          </select>
          <input id="providerFilter" placeholder="Provider" class="input" />
          <button id="refreshBtn" class="btn btn-primary">Refresh</button>
        </div>
      </div>

      <div class="legend" style="margin-top:8px;">
        <div class="item"><span class="dot" style="background:#06b6d4"></span> Scheduled</div>
        <div class="item"><span class="dot" style="background:#10b981"></span> Confirmed</div>
        <div class="item"><span class="dot" style="background:#ef4444"></span> Cancelled</div>
      </div>

      <div id="calendarWrap">
        <div id="calendar"></div>
      </div>
    </main>
  </div>

  <!-- Details Modal -->
  <div id="detailsModal"
    style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.4); align-items:center; justify-content:center;">
    <div
      style="background:#fff; border-radius:16px; max-width:720px; width:100%; padding:20px; box-shadow:0 20px 60px rgba(8,145,178,0.25);">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
        <div style="font-weight:700; color:#0e7490">Appointment Details</div>
        <button onclick="closeModal()" style="border:none;background:none;font-size:20px;cursor:pointer">âœ–</button>
      </div>
      <div id="modalContent" style="font-size:14px; color:#374151; margin-bottom:12px;"></div>
      <div class="section">
        <h4>Reschedule</h4>
        <input type="date" id="rsDate" class="input" />
        <input type="text" id="rsTime" placeholder="e.g., 3:00 PM" class="input" />
        <select id="rsType" class="select">
          <option>Consultation</option>
          <option>Crisis Intervention</option>
          <option>Follow-up Session</option>
          <option>Initial Assessment</option>
          <option>Group Therapy</option>
          <option>Medication Review</option>
        </select>
        <select id="rsTz" class="select">
          <option>America/New_York</option>
          <option>America/Chicago</option>
          <option>America/Denver</option>
          <option>America/Los_Angeles</option>
        </select>
        <button id="btnCheckSlots" class="btn">Check slots</button>
      </div>
      <div id="slotsWrap" style="padding:8px 16px; display:none;"></div>
      <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:12px;">
        <button id="btnPHI" class="btn">Show PHI</button>
        <button id="btnConfirm" class="btn" style="background:#10b981;color:#fff;border:none;">Confirm</button>
        <button id="btnReschedule" class="btn" style="background:#f59e0b;color:#fff;border:none;">Reschedule</button>
        <button id="btnCancel" class="btn" style="background:#ef4444;color:#fff;border:none;">Cancel</button>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = window.API_BASE || 'http://localhost:4000';

    // PHI masking helpers
    function maskPhone(phone) {
      if (!phone) return 'N/A';
      const digits = phone.replace(/\D/g, '');
      return `(***) ***-${digits.slice(-4)}`;
    }
    function initials(name) {
      if (!name) return 'Unknown';
      return name.split(/\s+/).filter(Boolean).slice(0, 2).map(n => n[0]).join('').toUpperCase();
    }

    function statusColor(status) {
      switch ((status || '').toLowerCase()) {
        case 'confirmed': return '#10b981';
        case 'cancelled': return '#ef4444';
        default: return '#06b6d4';
      }
    }

    async function fetchAppointments() {
      const params = new URLSearchParams();
      const status = document.getElementById('statusFilter').value;
      const date = document.getElementById('dateFilter').value;
      const provider = document.getElementById('providerFilter').value;

      if (status) params.append('status', status);
      if (date) params.append('date', date);
      if (provider) params.append('provider', provider);

      const res = await fetch(`${API_BASE}/api/admin/appointments?${params.toString()}`);
      const data = await res.json();
      if (!data.success) throw new Error(data.error || 'Failed to load appointments');
      return data.appointments || [];
    }

    function parseBufferFromNotes(notes) {
      if (!notes) return {};
      try { const obj = JSON.parse(notes); return obj || {}; } catch { return {}; }
    }

    function toCalendarEvents(appts) {
      return appts.map(a => {
        const meta = parseBufferFromNotes(a.notes);
        return ({
          id: a.id,
          title: `${a.appointment_type || 'Consultation'} â€¢ ${a.status}`,
          start: a.start_time || `${a.date}T${a.time}:00`,
          end: a.end_time || undefined,
          backgroundColor: statusColor(a.status),
          borderColor: statusColor(a.status),
          textColor: '#ffffff',
          extendedProps: {
            patient_name: a.patient_name,
            patient_phone: a.patient_phone,
            patient_email: a.patient_email,
            patient_initials: initials(a.patient_name),
            phone_masked: maskPhone(a.patient_phone),
            email: a.patient_email ? a.patient_email.replace(/(.).+(@.+)/, '$1***$2') : 'N/A',
            appointment_type: a.appointment_type,
            status: a.status,
            provider: a.provider,
            confirmation: (a.id || '').substring(5, 13).toUpperCase(),
            calendar_link: a.calendar_link || null,
            patient_id: a.patient_id || null,
            timezone: meta.timezone || 'America/New_York',
            duration_minutes: a.duration_minutes,
            buffer_before_minutes: meta.buffer_before_minutes || null,
            buffer_after_minutes: meta.buffer_after_minutes || null,
            start_time: a.start_time,
            end_time: a.end_time,
            notes: a.notes || ''
          }
        });
      });
    }

    let currentApptId = null;
    let showPHI = false;

    function openModal(contentHtml, apptId, status, extProps) {
      currentApptId = apptId;
      document.getElementById('modalContent').innerHTML = contentHtml;
      const modal = document.getElementById('detailsModal');
      modal.style.display = 'flex';

      // Enable/disable action buttons based on status
      const btnConfirm = document.getElementById('btnConfirm');
      const btnCancel = document.getElementById('btnCancel');
      const btnReschedule = document.getElementById('btnReschedule');

      const s = (status || '').toLowerCase();
      btnConfirm.disabled = s === 'confirmed' || s === 'cancelled';
      btnCancel.disabled = s === 'cancelled';

      btnConfirm.onclick = () => handleConfirm(currentApptId);
      btnCancel.onclick = () => handleCancel(currentApptId);
      btnReschedule.onclick = () => handleReschedule(currentApptId);

      const btnPHI = document.getElementById('btnPHI');
      btnPHI.onclick = () => { showPHI = !showPHI; btnPHI.textContent = showPHI ? 'Hide PHI' : 'Show PHI'; renderDetails(extProps); };
      renderDetails(extProps);
    }
    function renderDetails(p) {
      const statusBadge = (s) => { const cls = s === 'confirmed' ? 'badge-confirmed' : (s === 'cancelled' ? 'badge-cancelled' : 'badge-scheduled'); return `<span class=\"badge ${cls}\">${s}</span>`; };
      const patientName = showPHI ? (p.patient_name || 'N/A') : (p.patient_initials || 'N/A');
      const phone = showPHI ? (p.patient_phone || 'N/A') : (p.phone_masked || 'N/A');
      const email = showPHI ? (p.patient_email || 'N/A') : (p.email || 'N/A');
      const link = p.calendar_link ? `<div style=\"margin-top:8px\"><a href=\"${p.calendar_link}\" target=\"_blank\" class=\"link\">Open in Google Calendar</a></div>` : '';
      const buffers = (p.buffer_before_minutes || p.buffer_after_minutes) ? `<div><strong>Buffers:</strong> before ${p.buffer_before_minutes || 0}m â€¢ after ${p.buffer_after_minutes || 0}m</div>` : '';
      const when = (p.start_time) ? `${new Date(p.start_time).toLocaleString()}` : 'N/A';
      document.getElementById('modalContent').innerHTML = `
        <div style=\"display:grid;grid-template-columns:1fr 1fr;gap:12px;\">
          <div>
            <div><strong>Confirmation:</strong> ${p.confirmation}</div>
            <div><strong>Status:</strong> ${statusBadge(p.status)}</div>
            <div><strong>Type:</strong> ${p.appointment_type}</div>
            <div><strong>Provider:</strong> ${p.provider || 'Team'}</div>
            <div><strong>When:</strong> ${when} (${p.timezone || 'America/New_York'})</div>
          </div>
          <div>
            <div><strong>Client:</strong> ${patientName}</div>
            <div><strong>Phone:</strong> ${phone}</div>
            <div><strong>Email:</strong> ${email}</div>
            <div><strong>FHIR Client ID:</strong> ${p.patient_id || 'N/A'}</div>
          </div>
        </div>
        <div style=\"margin-top:8px;\">${buffers}</div>
        ${p.notes ? `<div style=\"margin-top:6px;color:#6b7280\"><strong>Notes:</strong> ${showPHI ? p.notes : 'â€¢â€¢â€¢'}</div>` : ''}
        ${link}
      `;
    }
    function closeModal() {
      document.getElementById('detailsModal').style.display = 'none';
    }

    async function initCalendar() {
      const calendarEl = document.getElementById('calendar');
      const calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        headerToolbar: { left: 'prev,next today', center: 'title', right: 'dayGridMonth,timeGridWeek,timeGridDay,listWeek' },
        eventClick: function (info) {
          const p = info.event.extendedProps;
          openModal('<div/>', info.event.id, p.status, p);
        }
      });

      async function refresh() {
        const appts = await fetchAppointments();
        const events = toCalendarEvents(appts);
        calendar.removeAllEvents();
        calendar.addEventSource(events);
      }

      document.getElementById('refreshBtn').addEventListener('click', refresh);
      document.getElementById('statusFilter').addEventListener('change', refresh);
      document.getElementById('dateFilter').addEventListener('change', refresh);
      document.getElementById('providerFilter').addEventListener('keydown', (e) => { if (e.key === 'Enter') refresh(); });

      calendar.render();
      await refresh();
    }

    document.addEventListener('DOMContentLoaded', initCalendar);

    // Actions
    async function handleConfirm(appointmentId) {
      if (!appointmentId) return;
      try {
        const res = await fetch(`${API_BASE}/voice/appointments/confirm`, {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ args: { appointment_id: appointmentId } })
        });
        const data = await res.json();
        if (data.success) {
          closeModal();
          location.reload();
        } else { alert(data.error || 'Failed to confirm'); }
      } catch (e) { alert('Confirm failed'); }
    }

    async function handleCancel(appointmentId) {
      if (!appointmentId) return;
      const reason = prompt('Reason for cancellation?');
      if (reason === null) return;
      try {
        const res = await fetch(`${API_BASE}/voice/appointments/cancel`, {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ args: { appointment_id: appointmentId, reason } })
        });
        const data = await res.json();
        if (data.success) {
          closeModal();
          location.reload();
        } else { alert(data.error || 'Failed to cancel'); }
      } catch (e) { alert('Cancel failed'); }
    }

    async function handleReschedule(appointmentId) {
      if (!appointmentId) return;
      const newDate = document.getElementById('rsDate').value;
      const newTime = document.getElementById('rsTime').value;
      if (!newDate || !newTime) { alert('Select date and time'); return; }
      try {
        const res = await fetch(`${API_BASE}/voice/appointments/reschedule`, {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ args: { appointment_id: appointmentId, new_date: newDate, new_time: newTime, reason: 'Dashboard reschedule' } })
        });
        const data = await res.json();
        if (data.success) {
          closeModal();
          location.reload();
        } else { alert(data.error || 'Failed to reschedule'); }
      } catch (e) { alert('Reschedule failed'); }
    }
    // Check available slots for reschedule using complex scheduling logic
    document.addEventListener('click', async (e) => {
      if (e.target && e.target.id === 'btnCheckSlots') {
        const date = document.getElementById('rsDate').value;
        const apptType = document.getElementById('rsType').value;
        const tz = document.getElementById('rsTz').value;
        if (!date) { alert('Pick a date'); return; }
        try {
          const res = await fetch(`${API_BASE}/voice/appointments/available-slots`, {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ args: { date, appointment_type: apptType, timezone: tz } })
          });
          const data = await res.json();
          const wrap = document.getElementById('slotsWrap');
          if (data.success) {
            wrap.style.display = 'block';
            wrap.innerHTML = `<div style=\"margin-bottom:6px;color:#374151\"><strong>${data.appointment_type}</strong> â€¢ ${data.slot_duration_minutes}m (+${data.buffer_before_minutes}/${data.buffer_after_minutes}m buffers)</div>` +
              (data.available_slots.length ? data.available_slots.map(t => `<button class=\"btn\" style=\"margin:4px\" onclick=\"document.getElementById('rsTime').value='${t}'\">${t}</button>`).join('') : '<div style=\"color:#991b1b\">No slots available</div>');
          } else {
            wrap.style.display = 'block';
            wrap.innerHTML = `<div style=\"color:#991b1b\">${data.error || 'Failed to load slots'}</div>`;
          }
        } catch (err) {
          const wrap = document.getElementById('slotsWrap'); wrap.style.display = 'block'; wrap.innerHTML = '<div style="color:#991b1b">Error loading slots</div>';
        }
      }
    });
  </script>
</body>

</html>